---
layout: post
title: Stored Access Policies For Azure Files
description: How to use Stored Access Policies for controlling access to Azure Files
author: Brian Davis
categories: how-to, 
tags: storage, azure files
date: 2020-05-08
comments: true
published: false
---

Lately, at work, I've been helping to lead an implementation of an Azure Files share for a client.  This is the second client we've set up with one, and it's a pretty elegant solution that mitigates the need for an on-prem file server.  It's also available everywhere and doesn't require being connected to a VPN, just to name a couple more benefits.  In order to provision access, we usually setup end users with either a mapped drive or, more recently, with [Azure Storage Explorer](https://azure.microsoft.com/en-us/features/storage-explorer/).  There are numerous advantages to using Storage Explorer, in my opinion, but that's not really the scope of this post.  However, the ability to use an SAS (Shared Access Signature) URI is one that is relevant.

Let me take a step back for a second.  There are numerous ways to secure access to an Azure Files share.  You can use traditional RBAC roles at the storage account level.  That way when a user logs in from Storage Explorer, the portal, or the portal app, the user gets the desired access.  If your storage account is of the Resource Manager variety and you need more fine grained control, you can use new [RBAC roles](https://docs.microsoft.com/en-us/azure/storage/files/storage-files-identity-auth-active-directory-enable#2-assign-access-permissions-to-an-identity) to do so.  If configuring a mapped drive, you can use one of the two storage account keys to setup access.  It's a bit nuclear because it's really intended to be used as administrative access, but the only way to map a drive is to use a storage account key per this [article](https://docs.microsoft.com/en-us/azure/storage/files/storage-how-to-use-files-windows#using-an-azure-file-share-with-windows), in fact. You can create an account SAS (because it's defined at the storage account level), or a Service SAS (defined at the Blob, File, Table, or Queue level) as mentioned [here](https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview).  It's a blessing and a curse to have so many options sometimes I think :smirk:.  But what happens if you have a requirement for controlling access for a contractor or a temporary employee, what's the best way to handle that?  And what if your share resides in a Classic deployment model and you can't take advantage of the more fine-grained RBAC roles?  We're going to talk about a bit of a hybrid approach using the aforementioned Service SAS.

A plain ol' SAS without any sort of policy is known as an ad-hoc SAS, as defined in this [article](https://docs.microsoft.com/en-us/azure/storage/common/storage-sas-overview).  During my research on the best way to balance access to the share with proper security, I found that the ad-hoc Service SAS (Service because I only wanted to provision access to the Files service) is a decent solution.  It's great for quick hits and temporary access, where the access will expire quickly.  When using these, the rule of thumb is to not set the expiration date for too long into the future.  If a user's contract isn't renewed for example, you want the SAS to expire pretty quickly so the risk of unauthorized access is at a minimum.  That's great, but what if you don't know when a user's contract will be up, or how many times they'll be renewed, etc.  Also, maybe you don't want to have to deal with constantly renewing their access every renewal period.  Maybe still you'd rather be able to revoke a user's access on-demand rather than wait for a SAS to expire, leaving the share exposed in the meantime. Enter the Stored Access Policy.

In my research, I came across Hussein Salman's excellent blog post series on [SAS](https://husseinsalman.com/securing-access-to-azure-storage-part-1-introduction/) and specifically on using them in conjunction with [stored access policies] (https://husseinsalman.com/securing-access-to-azure-storage-part-5-stored-access-policy/).  It really helped me weed thru the confusing landscape of secure, temporary access as I eluded to earlier.  Hussein's post on policies showed how to configure such a policy for Blob containers via the [Azure portal](https://portal.azure.com).  Yet, to my surprise when I went to the Azure Files section of the portal, there was no such UI for configuring a policy.  So, I endeavored to find out how to do it.  I eventually figured out how to do it using the Azure CLI.  It only takes a few commands and at the end you'll have an Azure Files Service URI based on a stored access policy which you can hand your end user that's as locked down as you like.  You'll also be able to revoke that URI at any time, like when your client informs you they haven't renewed the end user's contract.  Let's look at the commands in question:

